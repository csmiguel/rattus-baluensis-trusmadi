genotypes,
ncode = 2,
ind.names = row.names(genotypes),
loc.names = names(genotypes),
sep = "",
NA.char = "0",
ploidy = 2,
type = "codom")
saveRDS(gen_ad, "output/output7-genind.rds")
#2. export in STRUCTURE format
# create a second gen_ad object
gen_ad2 <- gen_ad
# hierfstat requires names of alleles to be be integers:
gen_ad2@all.names %<>%
sapply(function(x) {
plyr::mapvalues(
x,
letters,
1:length(letters))
})
# export in STRUCTURE format
hierfstat::genind2hierfstat(gen_ad2,
pop = adegenet::indNames(gen_ad2)) %>%
hierfstat::write.struct(fname = "output/temp")
# replace loci with only one allele genotyped with missing data
system("cat output/temp | sed 's/ 0 / -9 /g' > output/output6-genotypes.str; rm output/temp")
#3. write to table
write.table(genotypes, file = "output/output5-filtered-genotypes.tsv", quote = F)
###.............................................................................
# (c) Miguel Camacho Sánchez
# miguelcamachosanchez@gmail.com // miguelcamachosanchez.weebly.com
# https://scholar.google.co.uk/citations?user=1M02-S4AAAAJ&hl=en
# June 2020
###.............................................................................
#GOAL: reformat and filter genotypes from population genetics data
#PROJECT: amplicon-genotyping
###.............................................................................
library(dplyr)
#load genotypes
genotypes <- readRDS("data/intermediate/genotypes.rds")
init_gen <- genotypes
#load filtering parameters
source("src/parameters/parameters.r")
#load filtering functions
source("src/functions/gen-filt.r")
#remove non-scored loci
unscored_loci <- unscored(genotypes)
#   apply filter
genotypes <- genotypes[, !unscored_loci]
#filter out list of individuals
if (is.character(ind_to_remove)){
genotypes <- genotypes[!(rownames(genotypes) %in% ind_to_remove), ]
}
#filter out individuals according to their missing data
ind_miss <- ind(genotypes)
# apply filter
genotypes <-
genotypes[ind_miss, ]
#filter out loci according to their missing data
locus_miss <- locus(genotypes)
# apply filter
genotypes <-
genotypes[, locus_miss]
#remove monorphic loci (applied the latest)
monomorphic_loci <- monomorphic(genotypes)
# apply filter
genotypes <- genotypes[, !monomorphic_loci]
#filter out loci non in HW equilibrium
hw_rm <- nonhw(genotypes, pvalue_hw)
# apply filter
genotypes <-
genotypes[, names(genotypes) %in% hw_rm]
#create report
sink("output/population-filtering.log")
cat("input file has", nrow(init_gen), "individuals and ",
ncol(init_gen), "loci\n")
cat(ifelse(all(!unscored_loci), "0",
paste(names(unscored_loci)[unscored_loci], collapse = " ")),
"has/have not been genotyped and has been removed", "\n")
cat(ifelse(all(ind_miss), "0",
paste(names(ind_miss)[!ind_miss], collapse = " ")),
"samples has/have missing data above threshold",
max_missing_ind, "\n")
cat(ifelse(all(locus_miss), "0",
paste(names(locus_miss)[!locus_miss], collapse = " ")),
"loci has/have missing data above threshold",
max_missing_loci, "\n")
cat(ifelse(all(!monomorphic_loci), "0",
paste(names(monomorphic_loci)[monomorphic_loci], collapse = " ")),
"loci is/are monomorphic and have been removed", "\n")
cat(paste(hw_rm, collapse = " "),
"has/have been remved because it/they was/were not in HW equilibrium at p =", pvalue_hw,"\n")
cat("output file has", nrow(genotypes), "individuals and ",
ncol(genotypes), "loci", "\n")
sink()
#save filtered genotypes
saveRDS(genotypes, "data/intermediate/genotypes-filtered.rds")
rm(list=ls())
###.............................................................................
# (c) Miguel Camacho Sánchez
# miguelcamachosanchez@gmail.com // miguelcamachosanchez.weebly.com
# https://scholar.google.co.uk/citations?user=1M02-S4AAAAJ&hl=en
# June 2020
###.............................................................................
#GOAL: reformat and filter genotypes from population genetics data
#PROJECT: amplicon-genotyping
###.............................................................................
library(dplyr)
#load genotypes
genotypes <- readRDS("data/intermediate/genotypes.rds")
init_gen <- genotypes
#load filtering parameters
source("src/parameters/parameters.r")
#load filtering functions
source("src/functions/gen-filt.r")
#remove non-scored loci
unscored_loci <- unscored(genotypes)
#   apply filter
genotypes <- genotypes[, !unscored_loci]
#filter out list of individuals
if (is.character(ind_to_remove)){
genotypes <- genotypes[!(rownames(genotypes) %in% ind_to_remove), ]
}
#filter out individuals according to their missing data
ind_miss <- ind(genotypes)
# apply filter
genotypes <-
genotypes[ind_miss, ]
#filter out loci according to their missing data
locus_miss <- locus(genotypes)
# apply filter
genotypes <-
genotypes[, locus_miss]
#remove monorphic loci (applied the latest)
monomorphic_loci <- monomorphic(genotypes)
# apply filter
genotypes <- genotypes[, !monomorphic_loci]
#filter out loci non in HW equilibrium
hw_rm <- nonhw(genotypes, pvalue_hw)
# apply filter
genotypes <-
genotypes[, names(genotypes) %in% hw_rm]
#create report
sink("output/population-filtering.log")
cat("input file has", nrow(init_gen), "individuals and ",
ncol(init_gen), "loci\n")
cat(ifelse(all(!unscored_loci), "0",
paste(names(unscored_loci)[unscored_loci], collapse = " ")),
"has/have not been genotyped and has been removed", "\n")
cat(ifelse(all(ind_miss), "0",
paste(names(ind_miss)[!ind_miss], collapse = " ")),
"samples has/have missing data above threshold",
max_missing_ind, "\n")
cat(ifelse(all(locus_miss), "0",
paste(names(locus_miss)[!locus_miss], collapse = " ")),
"loci has/have missing data above threshold",
max_missing_loci, "\n")
cat(ifelse(all(!monomorphic_loci), "0",
paste(names(monomorphic_loci)[monomorphic_loci], collapse = " ")),
"loci is/are monomorphic and have been removed", "\n")
cat(paste(hw_rm, collapse = " "),
"has/have been remved because it/they was/were not in HW equilibrium at p =", pvalue_hw,"\n")
cat("output file has", nrow(genotypes), "individuals and ",
ncol(genotypes), "loci", "\n")
sink()
#save filtered genotypes
saveRDS(genotypes, "data/intermediate/genotypes-filtered.rds")
###.............................................................................
# (c) Miguel Camacho Sánchez
# miguelcamachosanchez@gmail.com // miguelcamachosanchez.weebly.com
# https://scholar.google.co.uk/citations?user=1M02-S4AAAAJ&hl=en
# June 2020
###.............................................................................
#GOAL: reformat genotypes
#PROJECT: amplicon-genotyping
###.............................................................................
library(adegenet)
library(hierfstat)
library(dplyr)
library(magrittr)
#load reformatting options
source("src/parameters/parameters.r")
#read genotypes
genotypes <-
readRDS("data/intermediate/genotypes-filtered.rds") %>%
apply(1, function(x) { #replace calls with one allele only, [a-z]0, with [a-z]
position <- grep("[a-z]0", x)
x[position] %<>% stringr::str_remove("0")
x
}) %>% t()
#1. convert to genind object
gen_ad <- adegenet::df2genind(
genotypes,
ncode = 2,
ind.names = row.names(genotypes),
loc.names = names(genotypes),
sep = "",
NA.char = "0",
ploidy = 2,
type = "codom")
saveRDS(gen_ad, "output/output7-genind.rds")
#2. export in STRUCTURE format
# create a second gen_ad object
gen_ad2 <- gen_ad
# hierfstat requires names of alleles to be be integers:
gen_ad2@all.names %<>%
sapply(function(x) {
plyr::mapvalues(
x,
letters,
1:length(letters))
})
# export in STRUCTURE format
hierfstat::genind2hierfstat(gen_ad2,
pop = adegenet::indNames(gen_ad2)) %>%
hierfstat::write.struct(fname = "output/temp")
# replace loci with only one allele genotyped with missing data
system("cat output/temp | sed 's/ 0 / -9 /g' > output/output6-genotypes.str; rm output/temp")
#3. write to table
write.table(genotypes, file = "output/output5-filtered-genotypes.tsv", quote = F)
genotypes
rm(list=ls())
rm(list=ls)
library(dplyr)
#load genotypes
genotypes <- readRDS("data/intermediate/genotypes.rds")
init_gen <- genotypes
#load filtering parameters
source("src/parameters/parameters.r")
#load filtering functions
source("src/functions/gen-filt.r")
#remove non-scored loci
unscored_loci <- unscored(genotypes)
#   apply filter
genotypes <- genotypes[, !unscored_loci]
#filter out list of individuals
if (is.character(ind_to_remove)){
genotypes <- genotypes[!(rownames(genotypes) %in% ind_to_remove), ]
}
#filter out individuals according to their missing data
ind_miss <- ind(genotypes)
# apply filter
genotypes <-
genotypes[ind_miss, ]
#filter out loci according to their missing data
locus_miss <- locus(genotypes)
# apply filter
genotypes <-
genotypes[, locus_miss]
#remove monorphic loci (applied the latest)
monomorphic_loci <- monomorphic(genotypes)
# apply filter
genotypes <- genotypes[, !monomorphic_loci]
#filter out loci non in HW equilibrium
hw_rm <- nonhw(genotypes, pvalue_hw)
# apply filter
genotypes <-
genotypes[, names(genotypes) %in% hw_rm]
#create report
sink("output/population-filtering.log")
cat("input file has", nrow(init_gen), "individuals and ",
ncol(init_gen), "loci\n")
cat(ifelse(all(!unscored_loci), "0",
paste(names(unscored_loci)[unscored_loci], collapse = " ")),
"has/have not been genotyped and has been removed", "\n")
cat(ifelse(all(ind_miss), "0",
paste(names(ind_miss)[!ind_miss], collapse = " ")),
"samples has/have missing data above threshold",
max_missing_ind, "\n")
cat(ifelse(all(locus_miss), "0",
paste(names(locus_miss)[!locus_miss], collapse = " ")),
"loci has/have missing data above threshold",
max_missing_loci, "\n")
cat(ifelse(all(!monomorphic_loci), "0",
paste(names(monomorphic_loci)[monomorphic_loci], collapse = " ")),
"loci is/are monomorphic and have been removed", "\n")
cat(paste(hw_rm, collapse = " "),
"has/have been remved because it/they was/were not in HW equilibrium at p =", pvalue_hw,"\n")
cat("output file has", nrow(genotypes), "individuals and ",
ncol(genotypes), "loci", "\n")
sink()
genotypes
rm(list=ls)
rm(list=ls())
#load genotypes
genotypes <- readRDS("data/intermediate/genotypes.rds")
init_gen <- genotypes
#load filtering parameters
source("src/parameters/parameters.r")
#load filtering functions
source("src/functions/gen-filt.r")
#remove non-scored loci
unscored_loci <- unscored(genotypes)
genotypes
#remove non-scored loci
unscored_loci <- unscored(genotypes)
#   apply filter
genotypes <- genotypes[, !unscored_loci]
genotypes
#filter out list of individuals
if (is.character(ind_to_remove)){
genotypes <- genotypes[!(rownames(genotypes) %in% ind_to_remove), ]
}
genotypes
#filter out individuals according to their missing data
ind_miss <- ind(genotypes)
# apply filter
genotypes <-
genotypes[ind_miss, ]
genotypes
#filter out loci according to their missing data
locus_miss <- locus(genotypes)
# apply filter
genotypes <-
genotypes[, locus_miss]
genotypes
#remove monorphic loci (applied the latest)
monomorphic_loci <- monomorphic(genotypes)
# apply filter
genotypes <- genotypes[, !monomorphic_loci]
genotypes
#filter out loci non in HW equilibrium
hw_rm <- nonhw(genotypes, pvalue_hw)
hw_rm
genotypes[, names(genotypes) %in% hw_rm]
names(genotypes) %in% hw_rm
!(names(genotypes) %in% hw_rm)
# apply filter
genotypes <-
genotypes[, !(names(genotypes) %in% hw_rm)]
#create report
sink("output/population-filtering.log")
cat("input file has", nrow(init_gen), "individuals and ",
ncol(init_gen), "loci\n")
cat(ifelse(all(!unscored_loci), "0",
paste(names(unscored_loci)[unscored_loci], collapse = " ")),
"has/have not been genotyped and has been removed", "\n")
cat(ifelse(all(ind_miss), "0",
paste(names(ind_miss)[!ind_miss], collapse = " ")),
"samples has/have missing data above threshold",
max_missing_ind, "\n")
cat(ifelse(all(locus_miss), "0",
paste(names(locus_miss)[!locus_miss], collapse = " ")),
"loci has/have missing data above threshold",
max_missing_loci, "\n")
cat(ifelse(all(!monomorphic_loci), "0",
paste(names(monomorphic_loci)[monomorphic_loci], collapse = " ")),
"loci is/are monomorphic and have been removed", "\n")
cat(paste(hw_rm, collapse = " "),
"has/have been remved because it/they was/were not in HW equilibrium at p =", pvalue_hw,"\n")
cat("output file has", nrow(genotypes), "individuals and ",
ncol(genotypes), "loci", "\n")
sink()
#save filtered genotypes
saveRDS(genotypes, "data/intermediate/genotypes-filtered.rds")
genotypes
rm(list=ls())
###.............................................................................
# (c) Miguel Camacho Sánchez
# miguelcamachosanchez@gmail.com // miguelcamachosanchez.weebly.com
# https://scholar.google.co.uk/citations?user=1M02-S4AAAAJ&hl=en
# June 2020
###.............................................................................
#GOAL: reformat genotypes
#PROJECT: amplicon-genotyping
###.............................................................................
library(adegenet)
library(hierfstat)
library(dplyr)
library(magrittr)
#load reformatting options
source("src/parameters/parameters.r")
#read genotypes
genotypes <-
readRDS("data/intermediate/genotypes-filtered.rds") %>%
apply(1, function(x) { #replace calls with one allele only, [a-z]0, with [a-z]
position <- grep("[a-z]0", x)
x[position] %<>% stringr::str_remove("0")
x
}) %>% t()
#1. convert to genind object
gen_ad <- adegenet::df2genind(
genotypes,
ncode = 2,
ind.names = row.names(genotypes),
loc.names = names(genotypes),
sep = "",
NA.char = "0",
ploidy = 2,
type = "codom")
saveRDS(gen_ad, "output/output7-genind.rds")
#2. export in STRUCTURE format
# create a second gen_ad object
gen_ad2 <- gen_ad
# hierfstat requires names of alleles to be be integers:
gen_ad2@all.names %<>%
sapply(function(x) {
plyr::mapvalues(
x,
letters,
1:length(letters))
})
# export in STRUCTURE format
hierfstat::genind2hierfstat(gen_ad2,
pop = adegenet::indNames(gen_ad2)) %>%
hierfstat::write.struct(fname = "output/temp")
# replace loci with only one allele genotyped with missing data
system("cat output/temp | sed 's/ 0 / -9 /g' > output/output6-genotypes.str; rm output/temp")
#3. write to table
write.table(genotypes, file = "output/output5-filtered-genotypes.tsv", quote = F)
rm(list=ls())
###.............................................................................
# (c) Miguel Camacho Sánchez
# miguelcamachosanchez@gmail.com // miguelcamachosanchez.weebly.com
# https://scholar.google.co.uk/citations?user=1M02-S4AAAAJ&hl=en
# June 2020
###.............................................................................
#GOAL: dada2
#PROJECT: amplicon-genotyping
###.............................................................................
library(dada2)
library(dplyr)
#load parameters for genotype calling
source("src/parameters/parameters.r")
#load function to cleas spurious ASVs
source("src/functions/remove-spurious-ASVs.r")
#samples
all_samples <- readLines("data/intermediate/samples-list")
#loci
loci <- readLines("data/intermediate/loci")
#if any subset is desired
loci_set <- loci
genotyping <- readRDS("data/intermediate/genotyping.rds")
#join genotypes and frequencies
tidy_genotype_frqs <-
tidy_genotypes %>%
dplyr::filter(allele != "0") %>%
dplyr::left_join(tidy_freqs,
by = c("sample" = "sample", "locus" = "locus", "allele" = "allele"))
#reformat GENOTYPES
#create data frame with genotypes
genotypes <-
genotyping %>%
sapply(function(x){
x$genotypes
}) %>%
do.call(what = cbind) %>%
{row.names(.) <- all_samples; .} %>%
as.data.frame() %>%
setNames(names(genotyping))
tidy_genotypes <-
genotypes %>% tibble::rownames_to_column("sample") %>%
reshape2::melt(id = "sample") %>%
dplyr::rename(locus = variable) %>%
tidyr::separate(col = value, into = c("allele1", "allele2"), sep  = 1) %>%
reshape2::melt(id = c("sample", "locus")) %>%
dplyr::rename(allele = value) %>%
dplyr::arrange(sample, locus, allele)
# reformat frequency
tidy_freqs <-
names(genotyping) %>%
lapply(function(x){
genotyping[[x]]$frq %>% #data frame with frequencies
tibble::rownames_to_column(var = "sample") %>%
reshape2::melt(id = "sample") %>%
dplyr::rename(allele = variable,
count = value) %>%
dplyr::mutate(locus = x)
}
) %>%
do.call(what = rbind)
#join genotypes and frequencies
tidy_genotype_frqs <-
tidy_genotypes %>%
dplyr::filter(allele != "0") %>%
dplyr::left_join(tidy_freqs,
by = c("sample" = "sample", "locus" = "locus", "allele" = "allele"))
#reformat ALLELE sequences
#create data frame with allele sequences
al_seqs <-
genotyping %>%
lapply(function(x) x$allele_seq) %>%
reshape2::melt() %>%
dplyr::rename(allele = name,
sequence = seq,
locus = L1) %>%
dplyr::select(locus, allele, sequence) %>%
dplyr::arrange(locus, allele)
#write alleles to fasta
seqinr::write.fasta(sequences = as.list(al_seqs$sequence),
names = paste(al_seqs$locus, al_seqs$allele, sep = "_"),
file.out = "output/output3-alleles.fasta")
#write multifasta: all alleles for all individuals
tidy_genotype_frqs %>%
dplyr::left_join(al_seqs, by = c("locus" = "locus", "allele" = "allele")) %>%
{seqinr::write.fasta(sequences = as.list(.$sequence),
names = paste(.$sample, .$locus, .$allele, sep = "_"),
file.out = "output/output4-individuals-x-alleles.fasta")}
#write allele frequencies
write.table(tidy_genotype_frqs,
file = "output/output6-allele-freqs.txt",
quote = F,
row.names = F)
#write genotype table
write.table(genotypes, file = "output/output1-genotypes.tsv", quote = F)
#save objects
saveRDS(genotypes, file = "data/intermediate/genotypes.rds")
saveRDS(al_seqs, file = "data/intermediate/allele_sequences.rds")
rm(list=ls())
genotyping
genotyping
rm(list=ls())
